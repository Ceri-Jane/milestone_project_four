# Deployment

Regulate was deployed to **Heroku** using a production-ready Django configuration with Gunicorn, WhiteNoise, PostgreSQL, and environment variables.  
This file documents the exact deployment steps and explains why each step is required in a real-world Django production setup.

Return to [README.md](../README.md)

---

## 1. Create the Heroku App

1. Log in to the Heroku Dashboard  
2. Select **New → Create new app**  
3. Choose a unique app name  
4. Select the **EU** region (recommended for UK users)

This creates the hosted environment where the Django project runs.

---

## 2. Provision PostgreSQL (Heroku Postgres)

Regulate uses SQLite locally for development and PostgreSQL in production.

1. Go to **Resources** in Heroku  
2. Add the **Heroku Postgres** add-on (Hobby / Hobby Dev)

Heroku automatically generates a `DATABASE_URL` config var, which is read in `settings.py` using `dj_database_url`.

This provides:

- a persistent production database  
- separation from local development data  
- a secure, managed Postgres connection string  

---

## 3. Configure Environment Variables (Heroku Config Vars)

In **Heroku → Settings → Config Vars**, the following variables are set (values hidden):

| KEY | Purpose |
|------|---------|
| `CSRF_TRUSTED_ORIGINS` | Allows secure POST requests from the live Heroku domain |
| `DATABASE_URL` | PostgreSQL connection string (auto-generated by Heroku Postgres) |
| `DEBUG` | Set to `False` in production |
| `SECRET_KEY` | Django cryptographic signing key |
| `STRIPE_PUBLIC_KEY` | Stripe publishable key (frontend use) |
| `STRIPE_SECRET_KEY` | Stripe secret API key (server-side use) |
| `STRIPE_PRICE_ID` | Stripe price reference for the subscription plan |
| `STRIPE_WEBHOOK_SECRET` | Validates Stripe webhook signatures |

---

## 4. Prepare the Project for Production

### Key production dependencies

The following packages are required for Heroku deployment and production behaviour:

- gunicorn  
- whitenoise  
- dj-database-url  
- psycopg2-binary  
- python-decouple  
- stripe  

All dependencies are listed in `requirements.txt`.

---

## 5. Configure Django Settings for Heroku

The following production behaviours are implemented in `settings.py`.

### Environment-based secrets (no hardcoding)

- `SECRET_KEY` and `DEBUG` are loaded from environment variables  
- Stripe keys and webhook secrets are environment-only  

### Allowed Hosts

    ALLOWED_HOSTS = [".herokuapp.com", "127.0.0.1", "localhost"]

### CSRF trusted origins (live domain posting)

`CSRF_TRUSTED_ORIGINS` is loaded from environment variables. This:

- prevents CSRF failures on the deployed domain  
- allows secure form submissions in production  

### Database switching (SQLite local → Postgres production)

- Default database is SQLite for local development  
- If `DATABASE_URL` exists, Django switches to Postgres automatically  

### Static file handling (WhiteNoise)

WhiteNoise is enabled in middleware and static storage is set to compressed manifest storage. This:

- supports production static serving without Nginx  
- ensures cached/hashed static files work correctly  

### Production security (HTTPS, secure cookies, HSTS)

When `DEBUG = False`, Regulate enables:

- HTTPS redirect  
- secure CSRF/session cookies  
- HSTS headers  

---

## 6. Add a Procfile

Create a file named `Procfile` at project root:

    web: gunicorn regulate_project.wsgi

---

## 7. Push Code to GitHub

    git add .
    git commit -m "Configure deployment for Heroku"
    git push

---

## 8. Connect Heroku to GitHub

In **Heroku → Deploy**:

1. Select GitHub  
2. Search for the repository  
3. Click Connect  
4. Choose branch → Deploy Branch  

---

## 9. Enable Dyno

In **Resources → Dynos**, enable:

- Eco Dyno (or equivalent)

Without an active dyno, the site will not run.

---

## 10. Configure Stripe Webhooks

Create a Stripe webhook endpoint pointing to:

    https://<your-heroku-app>.herokuapp.com/billing/webhook/

Add the generated secret to Heroku Config Vars as:

    STRIPE_WEBHOOK_SECRET

This ensures:

- subscription state updates correctly  
- trial activations sync properly  
- cancellations reflect immediately  

---

## 11. Verify Deployment

After deployment, the following checks were performed:

- Site loads correctly  
- Postgres database connected  
- Static files load (CSS, JS, images)  
- Auth flows work (signup/login/logout/reset)  
- Mood entry CRUD works  
- Free plan limits enforce correctly  
- Regulate+ upgrade and trial flows function  
- Stripe Checkout redirects correctly  
- Stripe webhook updates subscription status  
- Stripe billing portal opens correctly  
- Custom 404 and 500 pages render  
- HTTPS enforced  
- Mobile responsiveness validated  

---

## Live Deployment

**Live Site:**  
https://regulate-ms4-ceri-a1ea7fce9e89.herokuapp.com/

**Repository:**  
https://github.com/Ceri-Jane/milestone_project_four

---

Return to [README.md](../README.md)
