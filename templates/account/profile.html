{% extends "base.html" %}
{% load static %}

{# Page-specific SEO overrides: custom title + meta tags #}

{% block meta_description %}
<meta name="description" content="View and update your Regulate account details.">
{% endblock %}

{% block meta_keywords %}
<meta name="keywords" content="profile, account settings, regulate">
{% endblock %}

{% block title %}
<title>Regulate | Profile</title>
{% endblock %}

{% block content %}
<div class="form-wrapper">
    <div class="form-card dashboard-card">

        <!-- Page heading -->
        <h1 class="form-title">Your Profile</h1>

        <!-- Page description -->
        <p class="form-info">
            Manage your Regulate account details in one place.
        </p>

        <hr>

        <!-- Username management -->
        <div class="entry-card">
            <p><strong>Your Username:</strong> {{ request.user.username }}</p>
            <p>Update the name shown on your Regulate account.</p>

            <a href="{% url 'change_username' %}" class="select-btn">
                Change Username
            </a>
        </div>

        <!-- Email management -->
        <div class="entry-card">
            <p><strong>Your Email:</strong> {{ request.user.email }}</p>
            <p>Update the email address linked to your account.</p>

            <a href="{% url 'change_email' %}" class="select-btn">
                Change Email
            </a>
        </div>

        <!-- Password management -->
        <div class="entry-card">
            <p><strong>Your Password</strong></p>
            <p>Keep your account secure with a strong password.</p>

            <a href="{% url 'account_change_password' %}" class="select-btn">
                Change Password
            </a>
        </div>

        <!-- Subscription and billing section -->
        <div class="entry-card regulate-plus-card">
            <p><strong>Regulate+ & Billing</strong></p>

            {% if subscription %}

                <!-- Active free trial -->
                {% if subscription.status == "trialing" %}

                    {% if subscription.cancel_at or subscription.cancel_at_period_end %}
                        <p>
                            <strong>Your free trial is active, but it’s set to end.</strong>
                            You won’t be charged when the trial ends.
                        </p>
                    {% else %}
                        <p>
                            <strong>Your free trial is active.</strong>
                            You won’t be charged until your trial ends.
                        </p>
                    {% endif %}

                    {% if subscription.trial_end %}
                        <p class="form-info">
                            Trial ends:
                            <strong>{{ subscription.trial_end|date:"D j M Y" }}</strong>
                        </p>
                    {% endif %}

                    <!-- Stripe billing portal -->
                    <div class="text-center mt-3">
                        <a href="{% url 'billing_details' %}" class="select-btn">
                            Manage billing in Stripe
                        </a>
                    </div>

                <!-- Active paid subscription -->
                {% elif subscription.status == "active" %}
                    <p>
                        <strong>Your Regulate+ subscription is active.</strong>
                    </p>

                    {% if subscription.current_period_end %}
                        <p class="form-info">
                            Next renewal:
                            <strong>{{ subscription.current_period_end|date:"D j M Y" }}</strong>
                        </p>
                    {% endif %}

                    {% if subscription.cancel_at or subscription.cancel_at_period_end %}
                        <p class="form-info">
                            This subscription is set to end. You’ll keep access until the end date.
                        </p>
                    {% endif %}

                    <!-- Stripe billing portal -->
                    <div class="text-center mt-3">
                        <a href="{% url 'billing_details' %}" class="select-btn">
                            Manage billing in Stripe
                        </a>
                    </div>

                <!-- Subscription inactive -->
                {% else %}
                    <p>Your Regulate+ plan isn’t currently active.</p>
                    <p class="form-info">
                        You can restart your subscription any time (trial is only available once).
                    </p>

                    <a href="{% url 'start_subscription' %}" class="select-btn">
                        Restart Regulate+
                    </a>

                    <div class="text-center mt-3">
                        <a href="{% url 'billing_details' %}" class="select-btn">
                            Manage billing in Stripe
                        </a>
                    </div>
                {% endif %}

            {% else %}
                <!-- No subscription -->
                <p>
                    Try Regulate+ free for 5 days. You’ll enter card details on a secure Stripe checkout page,
                    but <strong>you won’t be charged until the trial ends</strong>. Cancel any time before then.
                </p>

                <p class="form-info">
                    This gives you space to see whether Regulate+ supports your routines — without pressure.
                </p>

                <a href="{% url 'start_trial' %}" class="select-btn">
                    Start 5-Day Free Trial
                </a>
            {% endif %}
        </div>

        <hr>

        <!-- Logout action -->
        <div class="entry-card">
            <p><strong>Log Out</strong></p>
            <p>Log out of your Regulate account safely.</p>

            <a href="{% url 'account_logout' %}" class="btn btn-danger w-100">
                Log Out
            </a>
        </div>

    </div>
</div>
{% endblock %}
